<script lang="ts">
	import { createEventDispatcher, get_current_component } from 'svelte/internal'

	import { forwardEventsBuilder } from '$lib/directives'
	import type { Items } from '$lib/types'
	import { classname, condition, createOptions } from '$lib/utils'

	/**
	 * Forward all native Events
	 */
	export let forwardEvents = forwardEventsBuilder(get_current_component())

	/**
	 * TODO
	 */
	export let items: Items = undefined

	/**
	 * TODO
	 */
	export let key: string | undefined = undefined

	/**
	 * Show Selected value in Preview mode
	 */
	export let preview: boolean = false

	/**
	 * TODO
	 */
	export let text: string | undefined = undefined

	/**
	 * Selected option's value
	 */
	export let value: any = undefined

	const dispatch = createEventDispatcher()

	$: classes = classname('select', { preview }, $$props.class)

	$: ({ options, fromValue, getKey, getText, toValue } = createOptions({ items, key, text }))

	function change(event: any) {
		dispatch('changed', (value = toValue(event.target.value)))
	}
</script>

{#if condition($$props)}
	{#if preview}
		<div {...$$restProps} class={classes}>
			{value}
		</div>
	{:else}
		<select value={fromValue(value)} on:change={change} use:forwardEvents {...$$restProps} class={classes}>
			{#if $$props.placeholder}
				<option disabled selected value="">{$$props.placeholder}</option>
			{/if}
			{#each $options as option}
				<option value={getKey(option)}>
					{getText(option)}
				</option>
			{/each}
		</select>
	{/if}
{/if}
